generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Difficulty {
  easy
  medium
  hard
}

enum TaskType {
  homework
  exam
  project
  reading
  quiz
  other
  life
}

enum TaskStatus {
  pending
  in_progress
  completed
  overdue
}

enum TaskCreatedFrom {
  syllabus
  manual
  nl_input
  calendar
}

enum StudyMaterialSource {
  upload
  link
  text
}

enum StudyContentType {
  study_plan
  flashcards
  quiz
}

enum EstimateFeedback {
  up
  down
  neutral
}

enum MealType {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
}

enum ScheduleBlockType {
  CLASS
  MEAL
  STUDY
  TRAVEL
  SLEEP
  EVENT
  BREAK
  WORK
  EXERCISE
  PERSONAL
}

model User {
  id              Int                 @id @default(autoincrement())
  supabaseId      String              @unique
  email           String              @unique
  name            String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  settings        UserSettings?
  courses         Course[]
  tasks           Task[]
  scheduleBlocks  ScheduleBlock[]
  mealPreferences MealPreference[]
  multipliers     UserMultiplier[]
  materials       StudyMaterial[]
}

model UserSettings {
  id            Int     @id @default(autoincrement())
  userId        Int     @unique
  user          User    @relation(fields: [userId], references: [id])
  wakeTime      String
  sleepTime     String
  travelBuffer  Int     @default(10)
  breakBuffer   Int     @default(5)
  maxStudyHours Int     @default(8)
  timezone      String  @default("America/New_York")
}

model Course {
  id             Int              @id @default(autoincrement())
  userId         Int
  user           User             @relation(fields: [userId], references: [id])
  name           String
  code           String
  difficulty     Difficulty
  classMeetings  ClassMeeting[]
  tasks          Task[]
  scheduleBlocks ScheduleBlock[]
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
}

model ClassMeeting {
  id         Int    @id @default(autoincrement())
  courseId   Int
  course     Course @relation(fields: [courseId], references: [id])
  daysOfWeek String // e.g., "MWF" or "TR"
  startTime  String
  endTime    String
  building   String
}

model Task {
  id               Int                 @id @default(autoincrement())
  userId           Int
  user             User                @relation(fields: [userId], references: [id])
  courseId         Int?
  course           Course?             @relation(fields: [courseId], references: [id])
  title            String
  description      String?
  type             TaskType
  dueAt            DateTime
  estimatedMinutes Int                 @default(60)
  priority         Int?                @default(5)
  status           TaskStatus          @default(pending)
  createdFrom      TaskCreatedFrom     @default(manual)
  completedAt      DateTime?
  notes            String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  timeLogs         TaskTimeLog[]
  studyMaterials   StudyMaterial[]
  studyContent     StudyContent[]
  scheduleBlocks   ScheduleBlock[]
}

model TaskTimeLog {
  id               Int                  @id @default(autoincrement())
  taskId           Int
  task             Task                 @relation(fields: [taskId], references: [id])
  startAt          DateTime
  endAt            DateTime
  durationMinutes  Int
  estimateFeedback EstimateFeedback?
  createdAt        DateTime             @default(now())
}

model MealPreference {
  id              Int      @id @default(autoincrement())
  userId          Int
  user            User     @relation(fields: [userId], references: [id])
  type            MealType
  startTime       String
  endTime         String
  durationMinutes Int
  importance      Int      @default(5)
}

model ScheduleBlock {
  id         Int               @id @default(autoincrement())
  userId     Int
  user       User              @relation(fields: [userId], references: [id])
  date       DateTime
  startAt    DateTime
  endAt      DateTime
  type       ScheduleBlockType
  label      String
  taskId     Int?
  task       Task?             @relation(fields: [taskId], references: [id])
  courseId   Int?
  course     Course?           @relation(fields: [courseId], references: [id])
  confidence Float             @default(1.0)
  meta       Json              @default("{}")
  createdAt  DateTime          @default(now())
}

model StudyMaterial {
  id          Int                  @id @default(autoincrement())
  userId      Int
  user        User                 @relation(fields: [userId], references: [id])
  taskId      Int
  task        Task                 @relation(fields: [taskId], references: [id])
  title       String
  sourceType  StudyMaterialSource
  url         String?
  contentText String?
  createdAt   DateTime             @default(now())
}

model StudyContent {
  id          Int              @id @default(autoincrement())
  taskId      Int
  task        Task             @relation(fields: [taskId], references: [id])
  type        StudyContentType
  contentJson String
  model       String
  createdAt   DateTime         @default(now())
}

model UserMultiplier {
  id          Int       @id @default(autoincrement())
  userId      Int
  user        User      @relation(fields: [userId], references: [id])
  courseId    Int?
  taskType    TaskType?
  multiplier  Float     @default(1.0)
  sampleCount Int       @default(1)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([userId, courseId, taskType])
}
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Difficulty {
  easy
  medium
  hard
}

enum TaskType {
  homework
  exam
  project
  reading
  quiz
  other
  life
}

enum TaskStatus {
  pending
  in_progress
  completed
  overdue
}

enum TaskCreatedFrom {
  syllabus
  manual
  nl_input
  calendar
}

enum StudyMaterialSource {
  upload
  link
  text
}

enum StudyContentType {
  study_plan
  flashcards
  quiz
}

enum EstimateFeedback {
  up
  down
  neutral
}

enum MealType {
  breakfast
  lunch
  dinner
  snack
}

enum ScheduleBlockType {
  class
  meal
  study
  travel
  sleep
  event
  snack
  break
  work
  exercise
  personal
}

model User {
  id             String           @id
  supabaseId     String           @unique
  email          String           @unique
  name           String?
  timeZone       String?          @default("America/New_York")
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  settings       UserSettings?
  courses        Course[]
  tasks          Task[]
  scheduleBlocks ScheduleBlock[]
  meals          MealPreference[]
  multipliers    UserMultiplier[]
  materials      StudyMaterial[]
  studyContent   StudyContent[]
}

model UserSettings {
  id                        String   @id @default(uuid())
  userId                    String   @unique
  user                      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  wakeTime                  String
  sleepTime                 String
  buildingWalkBufferMinutes Int
  commuteBufferMinutes      Int
  maxStudyMinutesPerDay     Int
  maxStudyBlockMinutes      Int
  timeZone                  String   @default("America/New_York")
  onboardingComplete        Boolean  @default(false)
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
}

model Course {
  id             String           @id @default(uuid())
  userId         String
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  name           String
  code           String
  difficulty     Difficulty       @default(medium)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  meetings       ClassMeeting[]
  tasks          Task[]
  scheduleBlocks ScheduleBlock[]
  UserMultiplier UserMultiplier[]
}

model ClassMeeting {
  id        String  @id @default(uuid())
  courseId  String
  course    Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  dayOfWeek Int
  startTime String
  endTime   String
  building  String?
}

model Task {
  id               String          @id @default(uuid())
  userId           String
  user             User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId         String?
  course           Course?         @relation(fields: [courseId], references: [id])
  title            String
  description      String?
  type             TaskType
  dueAt            DateTime
  estimatedMinutes Int             @default(60)
  priority         Int?            @default(5)
  status           TaskStatus      @default(pending)
  createdFrom      TaskCreatedFrom @default(manual)
  completedAt      DateTime?
  notes            String?
  atRisk           Boolean         @default(false)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  timeLogs         TaskTimeLog[]
  studyMaterials   StudyMaterial[]
  studyContent     StudyContent[]
  scheduleBlocks   ScheduleBlock[]
}

model TaskTimeLog {
  id               String            @id @default(uuid())
  taskId           String
  task             Task              @relation(fields: [taskId], references: [id], onDelete: Cascade)
  startAt          DateTime
  endAt            DateTime
  durationMinutes  Int
  estimateFeedback EstimateFeedback?
  createdAt        DateTime          @default(now())
}

model MealPreference {
  id                 String   @id @default(uuid())
  userId             String
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  mealType           MealType
  earliestTime       String
  latestTime         String
  typicalDurationMin Int
  importance         Int      @default(1)
  createdAt          DateTime @default(now())
}

model ScheduleBlock {
  id         String            @id @default(uuid())
  userId     String
  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  date       DateTime
  startAt    DateTime
  endAt      DateTime
  type       ScheduleBlockType
  label      String
  taskId     String?
  task       Task?             @relation(fields: [taskId], references: [id])
  courseId   String?
  course     Course?           @relation(fields: [courseId], references: [id])
  confidence Float             @default(1.0)
  meta       Json?
  createdAt  DateTime          @default(now())
}

model StudyMaterial {
  id          String              @id @default(uuid())
  userId      String
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  taskId      String
  task        Task                @relation(fields: [taskId], references: [id], onDelete: Cascade)
  title       String
  sourceType  StudyMaterialSource
  url         String?
  contentText String?
  createdAt   DateTime            @default(now())
}

model StudyContent {
  id          String           @id @default(uuid())
  taskId      String
  task        Task             @relation(fields: [taskId], references: [id], onDelete: Cascade)
  type        StudyContentType
  contentJson String
  model       String
  createdAt   DateTime         @default(now())
  User        User?            @relation(fields: [userId], references: [id])
  userId      String?
}

model UserMultiplier {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId    String?
  course      Course?   @relation(fields: [courseId], references: [id])
  taskType    TaskType?
  multiplier  Float     @default(1.0)
  sampleCount Int       @default(1)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([userId, courseId, taskType])
}
